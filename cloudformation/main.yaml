AWSTemplateFormatVersion: 2010-09-09

Description: ''

Resources:
  IAMRoleExecuteLambda:
    Type: AWS::IAM::Role
    Properties:
      RoleName: log_in_s3_bucket_destroyer
      Description: This role is used by Lambda to execute the function.
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "lambda.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole

  IAMPolicyExecuteLambda:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: log_in_s3_bucket_destroyer
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
              - "s3:ListBucket"
              - "s3:GetObject"
              - "s3:DeleteObject"
            Resource: "*"
      Roles:
        - !Ref IAMRoleExecuteLambda

  LambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: log_in_s3_bucket_destroyer
      # 一般設定
      Description: This function delete log files in S3 bucket.
      MemorySize: 128
      EphemeralStorage:
        Size: 512
      Timeout: 3
      SnapStart: # https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/snapstart.html?icmpid=docs_lambda_help
        ApplyOn: None
      # アクセス制限
      Role: !GetAtt IAMRoleExecuteLambda.Arn
      # 環境変数
      Environment:
        Variables:
          LOG_LEVEL: INFO
      PackageType: Zip
      Code:
        ZipFile: |
          import json

          def lambda_handler(event, context):
              print(event)

              return {
                  'statusCode': 200,
                  'body': json.dumps('Hello from Lambda!')
              }
      # ランタイム設定
      Runtime: python3.12
      Handler: index.lambda_handler
      Architectures:
        - x86_64
      RuntimeManagementConfig:
        UpdateRuntimeOn: Auto
      LoggingConfig:
        LogGroupName: !Ref LambdaLogGroup

  LambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: /aws/lambda/log_in_s3_bucket_destroyer
      RetentionInDays: 90
